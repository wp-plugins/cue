window.cue=window.cue||{},function(e,t,i,s,r){"use strict";var a;cue.data=_cueSettings,a=cue.data.l10n,i.extend(cue,{controller:{},model:{},view:{}}),r.media.view.settings.post.id=cue.data.settings.postId,r.media.view.settings.defaultProps={},s.plugins.silverlight[0].types.push("audio/x-ms-wma"),jQuery(function(){var e;e=cue.tracks=new cue.model.Tracks(cue.data.tracks),delete cue.data.tracks,new cue.view.PostForm({collection:e})})}(this,jQuery,_,mejs,wp),window.cue=window.cue||{},function(e,t,i,s){"use strict";var r,a=s.media.model.Attachment,n=cue.data.l10n;r=cue.workflows={frames:[],model:{},setModel:function(e){return this.model=e,this},get:function(e){var t="_"+e,i=this.frames[t]||null;return i=this[t].call(this,i),this.frames[t]=i,i},_addTracks:function(e){return s.Uploader.defaults.filters=[{title:n.workflows.addTracks.fileTypes,extensions:"m4a,mp3,ogg,wma"}],e?e:(e=new cue.view.MediaFrame({title:n.workflows.addTracks.frameTitle,library:{type:"audio"},button:{text:n.workflows.addTracks.frameButtonText},multiple:"add"}),e.state("embed").props.off("change:url",e.state("embed").debouncedScan),e.state("insert").on("insert",function(e){i.each(e.models,function(e){cue.tracks.push(e.toJSON().cue)})}),e.state("embed").on("select",function(){var e=this.props.toJSON(),t={audioId:"",audioUrl:e.url};"title"in e&&""!==e.title&&(t.title=e.title),cue.tracks.push(t)}),e)},_selectArtwork:function(e){var t=this;return s.Uploader.defaults.filters=[{files:n.workflows.selectArtwork.fileTypes,extensions:"jpg,jpeg,gif,png"}],e?e:(e=s.media({title:n.workflows.selectArtwork.frameTitle,library:{type:"image"},button:{text:n.workflows.selectArtwork.frameButtonText},multiple:!1}),e.on("open",function(){var e=this.get("library").get("selection"),i=t.model.get("artworkId"),s=[];i&&(s.push(a.get(i)),s[0].fetch()),e.reset(s)}),e.state("library").on("select",function(){var e=this.get("selection").first().toJSON();t.model.set({artworkId:e.id,artworkUrl:e.sizes.cue.url})}),e)},_selectAudio:function(e){var t=this;return s.Uploader.defaults.filters=[{title:n.workflows.selectAudio.fileTypes,extensions:"m4a,mp3,ogg,wma"}],e?e:(e=new cue.view.MediaFrame({title:n.workflows.selectAudio.frameTitle,library:{type:"audio"},button:{text:n.workflows.selectAudio.frameButtonText},multiple:!1}),e.state("embed").props.off("change:url",e.state("embed").debouncedScan),e.on("open",function(){var i=this.get("insert").get("selection"),s=t.model.get("audioId"),r=t.model.get("audioUrl"),n=r&&!s,o=[];s&&(o.push(a.get(s)),o[0].fetch()),i.reset(o),n?this.get("embed").props.set({url:r,title:t.model.get("title")}):this.get("embed").props.set({url:"",title:""}),e.setState(n?"embed":"insert")}),e.state("insert").on("insert",function(e){var s=e.first().toJSON().cue,r={},a=i.keys(t.model.attributes);i.without(a,["id","order"]),i.each(a,function(e){var i=t.model.get(e);!i&&e in s&&i!==s[e]&&(r[e]=s[e])}),r.audioId=s.audioId,r.audioUrl=s.audioUrl,t.model.set(r)}),e.state("embed").on("select",function(){var e=this.props.toJSON(),i={};i.audioId="",i.audioUrl=e.url,"title"in e&&""!==e.title&&(i.title=e.title),t.model.set(i)}),e.on("escape",function(){var e=r.model.toJSON();e.artworkUrl||e.audioUrl||r.model.destroy()}),e)}}}(this,jQuery,_,wp),window.cue=window.cue||{},function(e,t,i,s,r){"use strict";cue.model.Track=s.Model.extend({defaults:{artist:"",artworkId:"",artworkUrl:"",audioId:"",audioUrl:"",format:"",length:"",title:"",order:0}}),cue.model.Tracks=s.Collection.extend({model:cue.model.Track,comparator:function(e){return e.get("order")},fetch:function(){var e=this;return r.ajax.post("cue_get_playlist",{post_id:cue.data.settings.postId}).done(function(t){e.reset(t)})},save:function(e){return this.sort(),e=i.extend({},e,{post_id:cue.data.settings.postId,tracks:this.toJSON(),nonce:cue.data.settings.saveNonce}),r.ajax.post("cue_save_playlist_tracks",e)}})}(this,jQuery,_,Backbone,wp),window.cue=window.cue||{},function(e,t,i,s,r){"use strict";var a,n=cue.data.l10n;a=cue.workflows=cue.workflows||{},cue.view.MediaFrame=r.media.view.MediaFrame.Post.extend({createStates:function(){var e=this.options;this.states.add([new r.media.controller.Library({id:"insert",title:this.options.title,priority:20,toolbar:"main-insert",filterable:"uploaded",library:r.media.query(e.library),multiple:e.multiple?"reset":!1,editable:!1,allowLocalEdits:!0,displaySettings:!1,displayUserSettings:!1}),new r.media.controller.Embed({title:n.addFromUrl,menuItem:{text:n.addFromUrl,priority:120},type:"link"})])},bindHandlers:function(){r.media.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:create:main-insert",this.createToolbar,this),this.on("toolbar:create:main-embed",this.mainEmbedToolbar,this);var e={menu:{"default":"mainMenu"},content:{embed:"embedContent","edit-selection":"editSelectionContent"},toolbar:{"main-insert":"mainInsertToolbar"}};i.each(e,function(e,t){i.each(e,function(e,i){this.on(t+":render:"+i,this[e],this)},this)},this)},mainInsertToolbar:function(e){var t=this;this.selectionStatusToolbar(e),e.set("insert",{style:"primary",priority:80,text:t.options.button.text,requires:{selection:!0},click:function(){var e=t.state(),i=e.get("selection");t.close(),e.trigger("insert",i).reset()}})},mainEmbedToolbar:function(e){e.view=new r.media.view.Toolbar.Embed({controller:this,text:this.options.button.text})}}),cue.view.PostForm=r.Backbone.View.extend({el:"#post",saved:!1,events:{"click #publish":"buttonClick","click #save-post":"buttonClick"},initialize:function(){this.render()},render:function(){return this.views.add("#cue-section",[new cue.view.AddTracksButton({collection:this.collection}),new cue.view.TrackList({collection:this.collection})]),this},buttonClick:function(e){var i=this,s=t(e.target);return s.siblings(".spinner"),i.saved||this.collection.save().done(function(){i.saved=!0,s.click()}).fail(function(){}),i.saved}}),cue.view.AddTracksButton=r.Backbone.View.extend({id:"add-tracks",tagName:"p",events:{"click .button":"click"},render:function(){var e=t("<a />",{text:n.addTracks}).addClass("button button-secondary");return this.$el.html(e),this},click:function(e){e.preventDefault(),a.get("addTracks").open()}}),cue.view.TrackList=r.Backbone.View.extend({className:"cue-tracklist",tagName:"ol",initialize:function(){this.listenTo(this.collection,"add",this.addTrack),this.listenTo(this.collection,"add remove",this.updateOrder),this.listenTo(this.collection,"reset",this.render),this.render().$el.sortable({axis:"y",delay:150,forceHelperSize:!0,forcePlaceholderSize:!0,opacity:.6,start:function(e,t){t.placeholder.css("visibility","visible")},update:i.bind(function(){this.updateOrder()},this)})},render:function(){return this.$el.empty(),this.collection.each(this.addTrack,this),this.updateOrder(),this},addTrack:function(e){var t=new cue.view.Track({model:e});this.$el.append(t.render().el)},updateOrder:function(){i.each(this.$el.find(".cue-track"),function(e,i){var s=t(e).data("cid");this.collection.get(s).set("order",i)},this)}}),cue.view.Track=r.Backbone.View.extend({tagName:"li",className:"cue-track",template:r.template("cue-playlist-track"),events:{"change [data-setting]":"updateAttribute","click .js-toggle":"toggleOpenStatus","dblclick .cue-track-title":"toggleOpenStatus","click .js-close":"minimize","click .js-remove":"destroy"},initialize:function(){this.listenTo(this.model,"change:title",this.updateTitle),this.listenTo(this.model,"change",this.updateFields),this.listenTo(this.model,"destroy",this.remove)},render:function(){return this.$el.html(this.template(this.model.toJSON())).data("cid",this.model.cid),this.views.add(".cue-track-column-artwork",new cue.view.TrackArtwork({model:this.model,parent:this})),this.views.add(".cue-track-audio-group",new cue.view.TrackAudio({model:this.model,parent:this})),this},minimize:function(e){e.preventDefault(),this.$el.removeClass("is-open").find("input:focus").blur()},toggleOpenStatus:function(i){i.preventDefault(),this.$el.toggleClass("is-open").find("input:focus").blur(),this.$el.hasClass("is-open")&&t(e).trigger("resize")},updateAttribute:function(e){var i=t(e.target).data("setting"),s=e.target.value;this.model.get(i)!==s&&this.model.set(i,s)},updateFields:function(){var e,i,s=this.model.toJSON(),r=this.$el.find("[data-setting]");for(e in s)i=t("<div/>").html(s[e]).text(),r.filter('[data-setting="'+e+'"]').val(i)},updateTitle:function(){var e=this.model.get("title");this.$el.find(".cue-track-title .text").text(e?e:"Title")},destroy:function(){this.model.trigger("destroy",this.model)},remove:function(){this.$el.remove()}}),cue.view.TrackArtwork=r.Backbone.View.extend({tagName:"span",className:"cue-track-artwork",template:r.template("cue-playlist-track-artwork"),events:{click:"select"},initialize:function(e){this.parent=e.parent,this.listenTo(this.model,"change:artworkUrl",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.parent.$el.toggleClass("has-artwork",!i.isEmpty(this.model.get("artworkUrl"))),this},select:function(){a.setModel(this.model).get("selectArtwork").open()}}),cue.view.TrackAudio=r.Backbone.View.extend({tagName:"span",className:"cue-track-audio",template:r.template("cue-playlist-track-audio"),events:{"click .cue-track-audio-selector":"select"},initialize:function(e){this.parent=e.parent,this.listenTo(this.model,"change:audioUrl",this.refresh),this.listenTo(this.model,"destroy",this.cleanup)},render:function(){var e,r,a=this.model.toJSON(),n=this.$el.find(".mejs-audio").attr("id");return""===a.audioUrl&&n&&s.players[n].remove(),this.$el.html(this.template(this.model.toJSON())),e=this.$el.find(".cue-audio"),e.length&&(e.wrap("<body></body>"),r={features:["playpause","current","progress","duration"],pluginPath:cue.data.settings.pluginPath,success:i.bind(function(e,i,s){var r=t(s.container).parent();s.current.removeClass("mejs-time-current").addClass("cuemejs-time-current wp-ui-highlight"),t.nodeName(r.get(0),"body")&&r.replaceWith(r.get(0).childNodes)},this),error:function(e){var i=t(e),r=i.closest(".cue-track"),a=i.closest(".mejs-audio").attr("id");s.players[a].remove(),r.find("audio").remove()}},"m4a"===e.attr("src").split(".").pop()&&(r.pluginVars="isvideo=true"),e.mediaelementplayer(r)),this},refresh:function(){var e=this.model.toJSON(),t=this.$el.find(".mejs-audio").attr(" id"),i=t?s.players[t]:null;i&&""!==e.audioUrl?(i.pause(),i.setSrc(e.audioUrl)):this.render()},cleanup:function(){var e=(this.model.toJSON(),this.$el.find(".mejs-audio").attr("id")),t=e?s.players[e]:null;t&&t.remove()},select:function(){a.setModel(this.model).get("selectAudio").open()}})}(this,jQuery,_,mejs,wp);